name: Build OpenWRT 24.10.4 with Custom Packages

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-openwrt.yml'
  pull_request:
  workflow_dispatch:

env:
  OPENWRT_VERSION: "v24.10.4"
  TARGET_ARCH: "x86_64"
  CUSTOM_CONFIG_FILE: ".config"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Cleanup workspace
      run: |
        # 清理工作区，防止旧文件干扰
        sudo rm -rf * .* || true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 更新并安装依赖，将 python3-distutils 替换为 python3-venv
        sudo apt-get -qq update
        sudo apt-get -qq install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          libssl-dev \
          xsltproc \
          wget \
          unzip \
          python3 \
          python3-venv \
          python3-setuptools \
          file \
          libelf-dev \
          ecj \
          fastjar \
          java-propose-classpath \
          automake \
          autoconf \
          libtool \
          quilt \
          pkg-config \
          libusb-1.0-0-dev
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"
        df -h
        free -h

    - name: Clone OpenWRT source code
      run: |
        # 克隆源码并更新 feeds
        git clone --depth 1 --branch ${OPENWRT_VERSION} https://github.com/openwrt/openwrt openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        cd openwrt
        # 如果存在自定义配置文件，则使用它
        if [ -f "../${CUSTOM_CONFIG_FILE}" ]; then
          echo "Found custom config file, copying it."
          cp "../${CUSTOM_CONFIG_FILE}" .config
        else
          echo "No custom config file found, generating default config for ${TARGET_ARCH}."
          # 为目标架构生成一个默认配置
          echo "CONFIG_TARGET_${TARGET_ARCH}=y" > .config
          # 选择第一个子目标（通常是 generic）
          echo "CONFIG_TARGET_${TARGET_ARCH}_generic=y" >> .config
          # 选择一个默认的固件类型，这里以 ext4 为例
          echo "CONFIG_TARGET_${TARGET_ARCH}_generic_DEVICE_generic-ext4=y" >> .config
        fi

    - name: Update and install package selections
      run: |
        cd openwrt
        
        # 定义要安装的插件列表
        PACKAGES="\
        luci-app-adguardhome \
        luci-app-attendedsysupgrade \
        luci-app-autoupdate \
        luci-app-control-webrestriction \
        luci-app-control-weburl \
        luci-app-ddns-go \
        luci-app-firewall \
        luci-app-lucky \
        luci-app-netdata \
        luci-app-openclash \
        luci-app-package-manager \
        luci-app-passwall \
        luci-app-smartdns \
        luci-app-ttyd \
        luci-app-turboacc \
        luci-app-upnp \
        luci-app-vsftpd \
        luci-app-wol \
        luci-app-zerotier \
        luci-theme-argon \
        luci-i18n-base-zh-cn \
        luci-i18n-adguardhome-zh-cn \
        luci-i18n-attendedsysupgrade-zh-cn \
        luci-i18n-autoupdate-zh-cn \
        luci-i18n-control-webrestriction-zh-cn \
        luci-i18n-control-weburl-zh-cn \
        luci-i18n-ddns-go-zh-cn \
        luci-i18n-firewall-zh-cn \
        luci-i18n-lucky-zh-cn \
        luci-i18n-netdata-zh-cn \
        luci-i18n-openclash-zh-cn \
        luci-i18n-package-manager-zh-cn \
        luci-i18n-passwall-zh-cn \
        luci-i18n-smartdns-zh-cn \
        luci-i18n-ttyd-zh-cn \
        luci-i18n-turboacc-zh-cn \
        luci-i18n-upnp-zh-cn \
        luci-i18n-vsftpd-zh-cn \
        luci-i18n-wol-zh-cn \
        luci-i18n-zerotier-zh-cn \
        "
        
        # 将插件添加到配置文件中
        for pkg in $PACKAGES; do
          echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
        
        # 确保中文语言包被选中
        echo "CONFIG_LUCI_LANG_zh-cn=y" >> .config

    - name: Build config tools and update config
      run: |
        cd openwrt
        echo "Building config tools (scripts/config/conf)..."
        # 首先单独编译配置工具，使用 -j1 避免并行问题
        make -j1 scripts/config/conf V=s || { echo "Failed to build config tool!"; exit 1; }
        
        echo "Updating configuration..."
        # 然后再运行 defconfig 来处理依赖关系
        make defconfig V=s

    - name: Download package sources
      run: |
        cd openwrt
        make download -j$(nproc)
        find dl -size -1024c -delete

    - name: Compile firmware
      run: |
        cd openwrt
        echo "开始编译，这可能需要很长时间..."
        make -j$(nproc) || make -j1 V=s

    - name: Upload compiled firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-${{ env.TARGET_ARCH }}-${{ env.OPENWRT_VERSION }}
        path: openwrt/bin/targets/**/*.bin
        if-no-files-found: error
