name: Build OpenWrt 22.03

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache file gawk gettext git
        sudo apt-get install -y libncurses5-dev libssl-dev python3 python3-distutils
        sudo apt-get install -y rsync unzip wget zlib1g-dev
        
    - name: Download OpenWrt 22.03
      run: |
        wget -q https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        mv openwrt-sdk-* openwrt
        
    - name: Setup feeds
      run: |
        cd openwrt
        echo "src-git argon https://github.com/jerrykuku/luci-theme-argon.git" >> feeds.conf.default
        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git" >> feeds.conf.default
        echo "src-git openclash https://github.com/vernesong/OpenClash.git" >> feeds.conf.default
        echo "src-git smartdns https://github.com/pymumu/smartdns.git" >> feeds.conf.default
        echo "src-git adguardhome https://github.com/rufengsuixing/luci-app-adguardhome.git" >> feeds.conf.default
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Configure build
      run: |
        cd openwrt
        # 使用简单的echo命令创建配置文件，避免多行字符串问题
        echo "CONFIG_TARGET_x86_64=y" > .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_LUCI_LANG_zh-cn=y" >> .config
        
        # 官方插件
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoupdate=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        
        # 第三方插件
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        
        # 中文语言包
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
        
    - name: Build firmware
      run: |
        cd openwrt
        make -j2 download
        make -j2
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: openwrt/bin/targets/
        retention-days: 7
