name: Build OpenWRT 24.10.4 with Custom Packages

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-openwrt.yml'
  pull_request:
  workflow_dispatch:

env:
  OPENWRT_VERSION: "v24.10.4"
  TARGET_ARCH: "x86_64"
  CUSTOM_CONFIG_FILE: ".config"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Cleanup workspace
      run: |
        sudo rm -rf * .* || true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 补充可能缺失的编译依赖（针对 zstd 编译）
        sudo apt-get -qq update
        sudo apt-get -qq install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          libssl-dev \
          xsltproc \
          wget \
          unzip \
          python3 \
          python3-venv \
          python3-setuptools \
          file \
          libelf-dev \
          ecj \
          fastjar \
          java-propose-classpath \
          automake \
          autoconf \
          libtool \
          quilt \
          pkg-config \
          libusb-1.0-0-dev \
          cmake \  # 新增：zstd 可能依赖 cmake 构建
          gcc-multilib \  # 新增：兼容 32/64 位编译
          g++-multilib
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"
        df -h
        free -h

    - name: Clone OpenWRT source code
      run: |
        git clone --depth 1 --branch ${OPENWRT_VERSION} https://github.com/openwrt/openwrt openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build config tools (conf) FIRST
      run: |
        cd openwrt
        echo "Building config tool (scripts/config/conf) with clean environment..."
        env -i PATH="$PATH" make -j1 scripts/config/conf V=s || { echo "Failed to build config tool!"; exit 1; }

    - name: Load custom configuration
      run: |
        cd openwrt
        if [ -f "../${CUSTOM_CONFIG_FILE}" ]; then
          echo "Found custom config file, copying it."
          cp "../${CUSTOM_CONFIG_FILE}" .config
        else
          echo "No custom config file found, generating default config for ${TARGET_ARCH}."
          make defconfig
        fi

    - name: Update and install package selections
      run: |
        cd openwrt
        
        # 包含之前缺失的依赖包
        PACKAGES="\
        luci-app-adguardhome \
        luci-app-attendedsysupgrade \
        luci-app-autoupdate \
        luci-app-control-webrestriction \
        luci-app-control-weburl \
        luci-app-ddns-go \
        luci-app-firewall \
        luci-app-lucky \
        luci-app-netdata \
        luci-app-openclash \
        luci-app-package-manager \
        luci-app-passwall \
        luci-app-smartdns \
        luci-app-ttyd \
        luci-app-turboacc \
        luci-app-upnp \
        luci-app-vsftpd \
        luci-app-wol \
        luci-app-zerotier \
        luci-theme-argon \
        luci-i18n-base-zh-cn \
        luci-i18n-adguardhome-zh-cn \
        luci-i18n-attendedsysupgrade-zh-cn \
        luci-i18n-autoupdate-zh-cn \
        luci-i18n-control-webrestriction-zh-cn \
        luci-i18n-control-weburl-zh-cn \
        luci-i18n-ddns-go-zh-cn \
        luci-i18n-firewall-zh-cn \
        luci-i18n-lucky-zh-cn \
        luci-i18n-netdata-zh-cn \
        luci-i18n-openclash-zh-cn \
        luci-i18n-package-manager-zh-cn \
        luci-i18n-passwall-zh-cn \
        luci-i18n-smartdns-zh-cn \
        luci-i18n-ttyd-zh-cn \
        luci-i18n-turboacc-zh-cn \
        luci-i18n-upnp-zh-cn \
        luci-i18n-vsftpd-zh-cn \
        luci-i18n-wol-zh-cn \
        luci-i18n-zerotier-zh-cn \
        # 之前缺失的依赖包
        libpam \
        libtirpc \
        lzma \
        net-snmp \
        "
        
        for pkg in $PACKAGES; do
          echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
        
        echo "CONFIG_LUCI_LANG_zh-cn=y" >> .config

    - name: Update configuration with defconfig
      run: |
        cd openwrt
        echo "Updating configuration with defconfig..."
        make defconfig V=s

    - name: Download package sources (with zstd cleanup)
      run: |
        cd openwrt
        # 关键：删除可能损坏的 zstd 源码包，强制重新下载
        rm -f dl/zstd-1.5.7.tar.gz*
        # 重新下载所有源码包（确保 zstd 完整）
        make download -j$(nproc)
        # 检查下载的 zstd 包是否完整
        if [ ! -f "dl/zstd-1.5.7.tar.gz" ]; then
          echo "zstd source package download failed!"
          exit 1
        fi
        find dl -size -1024c -delete

    - name: Compile tools (zstd first, single-thread)
      run: |
        cd openwrt
        echo "Compiling tools (zstd first with single thread)..."
        # 关键：单线程编译 zstd，避免并行冲突
        make tools/zstd/compile -j1 V=s || { echo "Failed to compile zstd!"; exit 1; }
        # 编译剩余工具（仍可用多线程，但若继续失败可改为 -j1）
        make tools/compile -j$(nproc) V=s

    - name: Compile firmware
      run: |
        cd openwrt
        echo "开始编译固件，这可能需要很长时间..."
        make -j$(nproc) || make -j1 V=s

    - name: Upload compiled firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-${{ env.TARGET_ARCH }}-${{ env.OPENWRT_VERSION }}
        path: openwrt/bin/targets/**/*.bin
        if-no-files-found: error
