name: Build-OpenWrt-24.10.4

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    #==============================================================
    # 1. 初始化构建环境（删除不必要组件，节省空间）
    #==============================================================
    - name: Init build env
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex g++ gawk gcc-multilib \
            gettext git libncurses-dev libssl-dev python3 unzip zlib1g-dev \
            file wget ccache python3-pip jq

    #==============================================================
    # 2. 设置 ccache 加速（缓存加速）
    #==============================================================
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Enable ccache
      run: |
        echo 'export CC="ccache gcc"' >> $GITHUB_ENV
        echo 'export CXX="ccache g++"' >> $GITHUB_ENV
        echo 'export CCACHE_DIR=~/.ccache' >> $GITHUB_ENV
        ccache -M 2G

    #==============================================================
    # 3. 克隆 OpenWrt 源码（24.10.4）
    #==============================================================
    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt.git -b v24.10.4 openwrt

    #==============================================================
    # 4. 下载第三方插件
    #==============================================================
    - name: Add extra packages
      run: |
        cd openwrt/package
        git clone --depth=1 https://github.com/gdy666/luci-app-lucky
        git clone --depth=1 https://github.com/vernesong/OpenClash
        git clone --depth=1 https://github.com/xiaorouji/openwrt-passwall passwall
        git clone --depth=1 https://github.com/jerrykuku/luci-theme-argon
        git clone --depth=1 https://github.com/jerrykuku/luci-app-argon-config
        git clone --depth=1 https://github.com/sirpdboy/luci-app-ddns-go
        git clone --depth=1 https://github.com/pymumu/openwrt-smartdns smartdns
        git clone --depth=1 https://github.com/pymumu/luci-app-smartdns

    #==============================================================
    # 5. 更新 feeds
    #==============================================================
    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    #==============================================================
    # 6. 导入配置（含裁剪优化）
    #==============================================================
    - name: Load .config
      run: |
        cd openwrt
        cat > .config << "EOF"
        #-------------------------------
        #  Platform: x86_64
        #-------------------------------
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y

        #-------------------------------
        #  Plugins
        #-------------------------------
        CONFIG_PACKAGE_luci-app-attendedsysupgrade=y
        CONFIG_PACKAGE_luci-app-autoupdate=y
        CONFIG_PACKAGE_luci-app-package-manager=y

        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-ddns-go=y
        CONFIG_PACKAGE_luci-app-upnp=y
        CONFIG_PACKAGE_luci-app-vsftpd=y
        CONFIG_PACKAGE_luci-app-zerotier=y

        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-netdata=y
        CONFIG_PACKAGE_luci-app-openclash=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-turboacc=y

        CONFIG_PACKAGE_luci-app-control-webrestriction=y
        CONFIG_PACKAGE_luci-app-control-weburl=y

        CONFIG_PACKAGE_luci-app-ttyd=y
        CONFIG_PACKAGE_luci-app-adguardhome=y
        CONFIG_PACKAGE_luci-app-wol=y
        CONFIG_PACKAGE_luci-app-lucky=y

        CONFIG_PACKAGE_luci-theme-argon=y
        CONFIG_PACKAGE_luci-app-argon-config=y

        #-------------------------------
        #  Language
        #-------------------------------
        CONFIG_LUCI_LANG_zh_Hans=y

        #-------------------------------
        #  Enable ccache
        #-------------------------------
        CONFIG_DEVEL=y
        CONFIG_CCACHE=y

        #-------------------------------
        #  自动裁剪（精简系统）
        #-------------------------------
        CONFIG_STRIP_KERNEL_EXPORTS=y
        CONFIG_USE_MUSL=y
        CONFIG_KERNEL_ELF_CORE=y

        CONFIG_BUILD_PATENTED=y
        CONFIG_PACKAGE_kmod-ppp-nol2tp=y
        CONFIG_PACKAGE_kmod-tcp-bbr=y

        CONFIG_IMAGEOPT=y
        CONFIG_IB=y

        # 移除文档以节省空间
        # CONFIG_BUILD_LOG is not set
        # CONFIG_KERNEL_KALLSYMS is not set
        # CONFIG_KERNEL_KALLSYMS_ALL is not set

        EOF

    #==============================================================
    # 7. defconfig
    #==============================================================
    - name: Defconfig
      run: |
        cd openwrt
        make defconfig

    #==============================================================
    # 8. 编译
    #==============================================================
    - name: Build
      run: |
        cd openwrt
        make -j$(nproc) V=s

    #==============================================================
    # 9. 上传固件
    #==============================================================
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-x86_64
        path: openwrt/bin/targets/x86/64/