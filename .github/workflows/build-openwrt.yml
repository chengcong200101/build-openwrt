name: Build OpenWrt 22.03 with All Plugins

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git wget
        sudo apt-get install -y libssl-dev zlib1g-dev unzip rsync
        sudo apt-get install -y gawk gettext libncurses5-dev
        
    - name: Download and setup OpenWrt
      run: |
        wget -q https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -1)
        echo "Found SDK directory: $SDK_DIR"
        mv "$SDK_DIR" openwrt
        cd openwrt
        
    - name: Add custom feeds
      run: |
        cd openwrt
        echo "src-git argon https://github.com/jerrykuku/luci-theme-argon.git" >> feeds.conf.default
        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git" >> feeds.conf.default
        echo "src-git openclash https://github.com/vernesong/OpenClash.git" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Configure build
      run: |
        cd openwrt
        # 基础配置
        echo "CONFIG_TARGET_x86_64=y" > .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        
        # LuCI 基础
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_LUCI_LANG_zh-cn=y" >> .config
        
        # 官方插件
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoupdate=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        
        # 第三方插件
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        
        # 中文语言包
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        
        # 禁用有问题的包
        echo "CONFIG_PACKAGE_pcapsipdump=n" >> .config
        
    - name: Download packages with retry
      run: |
        cd openwrt
        # 第一次尝试下载
        make -j1 download || true
        
        # 清理可能失败的下载
        find dl -size -1024c -exec rm -f {} \; || true
        
        # 第二次尝试下载
        make -j1 download || true
        
        # 显示下载状态
        echo "Download status:"
        ls -la dl/ | wc -l
        echo "files in dl directory"
        
    - name: Build firmware
      run: |
        cd openwrt
        make defconfig
        # 跳过依赖检查，直接构建
        make -j2 IGNORE_ERRORS=m || make -j1 V=s IGNORE_ERRORS=m
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-full-plugins
        path: openwrt/bin/targets/