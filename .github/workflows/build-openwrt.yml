# .github/workflows/build.yml
name: Build OpenWrt 22.03 with All Plugins

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Build OpenWrt 22.03
      run: |
        # 安装依赖
        sudo apt update && sudo apt install -y build-essential ccache git libssl-dev python2.7 unzip wget
        
        # 下载 22.03.5 源码
        wget https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        mv openwrt-sdk-* openwrt
        cd openwrt
        
        # 添加第三方源
        cat >> feeds.conf.default << 'EOF'
        src-git argon https://github.com/jerrykuku/luci-theme-argon.git
        src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main
        src-git openclash https://github.com/vernesong/OpenClash.git
        src-git smartdns https://github.com/pymumu/smartdns.git
        src-git adguardhome https://github.com/rufengsuixing/luci-app-adguardhome.git
        src-git lucky https://github.com/sirpdboy/luci-app-lucky.git
        src-git turboacc https://github.com/chenmozhijin/turboacc.git
        EOF
        
        # 更新 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 生成配置
        cat > .config << 'EOF'
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        
        # 基础系统
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_LUCI_LANG_zh-cn=y
        
        # 官方插件
        CONFIG_PACKAGE_luci-app-attendedsysupgrade=y
        CONFIG_PACKAGE_luci-app-autoupdate=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-upnp=y
        CONFIG_PACKAGE_luci-app-wol=y
        CONFIG_PACKAGE_luci-app-ttyd=y
        CONFIG_PACKAGE_luci-app-vsftpd=y
        CONFIG_PACKAGE_luci-app-zerotier=y
        
        # 第三方插件
        CONFIG_PACKAGE_luci-theme-argon=y
        CONFIG_PACKAGE_luci-app-adguardhome=y
        CONFIG_PACKAGE_luci-app-ddns-go=y
        CONFIG_PACKAGE_luci-app-lucky=y
        CONFIG_PACKAGE_luci-app-netdata=y
        CONFIG_PACKAGE_luci-app-openclash=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-turboacc=y
        
        # 中文语言包
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y
        EOF
        
        # 编译
        make -j$(nproc) || make -j1 V=s
        
    - name: Upload Firmware
      uses: actions/upload-artifact@v3
      with:
        name: openwrt-22.03-full-plugins
        path: openwrt/bin/targets/
